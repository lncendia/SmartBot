using System.Diagnostics.CodeAnalysis;
using SmartBot.Abstractions.Enums;
using SmartBot.Abstractions.Models.Reports;
using SmartBot.Abstractions.Models.WorkingChats;

namespace SmartBot.Abstractions.Models.Users;

/// <summary>
/// Модель пользователя системы отчетности
/// </summary>
/// <remarks>
/// Основная сущность, содержащая информацию о пользователе и его состоянии в системе.
/// Хранит как персональные данные, так и рабочую контекстную информацию.
/// </remarks>
public class User
{
    /// <summary>
    /// Уникальный идентификатор пользователя в Telegram
    /// </summary>
    /// <value>
    /// Положительное число, соответствующее user_id в Telegram API
    /// </value>
    public required long Id { get; init; }

    /// <summary>
    /// Полное имя пользователя (ФИО)
    /// </summary>
    /// <value>
    /// Строка в формате "Фамилия Имя Отчество". Может быть null до завершения регистрации.
    /// </value>
    public string? FullName { get; set; }

    /// <summary>
    /// Должность/позиция пользователя в компании
    /// </summary>
    /// <value>
    /// Например: "Менеджер по продажам", "Разработчик Python". Может быть null.
    /// </value>
    public string? Position { get; set; }

    /// <summary>
    /// Дата и время регистрации пользователя в системе
    /// </summary>
    /// <value>
    /// UTC время. Заполняется автоматически при создании пользователя.
    /// </value>
    public DateTime RegistrationTime { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Текущее состояние пользователя в системе
    /// </summary>
    /// <value>
    /// Определяет доступные действия и ожидаемый ввод от пользователя.
    /// По умолчанию: Ожидание ввода ФИО (первый шаг регистрации).
    /// </value>
    public State State { get; set; } = State.AwaitingFullNameInput;

    /// <summary>
    /// Роль пользователя в системе
    /// </summary>
    /// <value>
    /// Определяет уровень доступа и функциональные возможности.
    /// По умолчанию: Сотрудник (базовые права).
    /// </value>
    public Role Role { get; set; } = Role.Employee;

    /// <summary>
    /// Идентификатор рабочего чата пользователя
    /// </summary>
    /// <value>
    /// ID чата, в котором пользователь отправляет отчеты.
    /// Null означает, что чат не назначен.
    /// </value>
    public long? WorkingChatId { get; set; }

    /// <summary>
    /// Рабочий чат пользователя
    /// </summary>
    /// <value>
    /// Навигационное свойство
    /// </value>
    public WorkingChat? WorkingChat { get; init; }

    /// <summary>
    /// Флаг, указывающий наличие административных прав
    /// </summary>
    /// <value>
    /// true - пользователь имеет права Admin или TeleAdmin
    /// false - обычный сотрудник или заблокированный пользователь
    /// </value>
    public bool IsAdmin => Role is Role.Admin or Role.TeleAdmin;

    /// <summary>
    /// Флаг, указывающий статус сотрудника
    /// </summary>
    /// <value>
    /// true - пользователь является сотрудником (Employee или TeleAdmin)
    /// false - администратор или заблокированный пользователь
    /// </value>
    public bool IsEmployee => Role is Role.Employee or Role.TeleAdmin;

    /// <summary>
    /// Контекст проверки отчета (для администраторов)
    /// </summary>
    /// <value>
    /// Содержит информацию о проверяемом отчете.
    /// Null - нет активной проверки.
    /// </value>
    public ReviewingReport? ReviewingReport { get; set; }

    /// <summary>
    /// Временный идентификатор чата для назначения (администраторский функционал)
    /// </summary>
    /// <value>
    /// ID чата, выбранного администратором для назначения пользователю.
    /// Используется в процессе настройки рабочего пространства.
    /// </value>
    public long? SelectedWorkingChatId { get; set; }

    /// <summary>
    /// Контекст ответа на сообщение
    /// </summary>
    /// <value>
    /// Содержит информацию о сообщении, на которое пользователь отвечает.
    /// Null - нет активного ответа.
    /// </value>
    public AnswerFor? AnswerFor { get; set; }

    /// <summary>
    /// Контекст текущего отчёта
    /// </summary>
    /// <value>
    /// Содержит информацию о текущем введенном отчёте пользователя.
    /// Null - нет введенного отчёта.
    /// </value>
    public string? CurrentReport { get; set; }

    /// <summary>
    /// Коллекция отчетов пользователя
    /// </summary>
    /// <value>
    /// Навигационное свойство для доступа ко всем отчетам пользователя.
    /// Автоматически инициализируется пустым списком.
    /// </value>
    [SuppressMessage("ReSharper", "CollectionNeverUpdated.Global")]
    public List<Report> Reports { get; init; } = [];

    /// <summary>
    /// Текущий рейтинговый счет пользователя.
    /// Начисляется за качественные отчеты и активность.
    /// </summary>
    public double Score { get; set; }

    /// <summary>
    /// Возвращает количество очков, недостающих до следующего звания.
    /// </summary>
    /// <returns>
    /// Количество очков до следующего уровня.
    /// 0 если уже максимальное звание.
    /// </returns>
    public double PointsToNextRank => Score switch
    {
        < 20 => 20 - Score,
        < 50 => 50 - Score,
        >= 4000 => 0,
        _ => Math.Floor((Score + 50) / 100) * 50 - Score
    };

    /// <summary>
    /// Текущее звание пользователя на основе набранных очков.
    /// </summary>
    public string Rank => Score switch
    {
        < 20 => "🐌 Базовый халтурщик",
        < 50 => "🦥 Офисный овощ",
        < 100 => "🛌 Сонный сотрудник",
        < 150 => "📉 Мастер прокрастинации",
        < 200 => "🍕 Пожиратель дедлайнов",
        < 250 => "🤷‍♂️ Ничего не знающий эксперт",
        < 300 => "🪑 Генератор отчетов",
        < 350 => "📊 Слепой аналитик",
        < 400 => "💸 Раб на галере",
        < 450 => "🖥️ Кнопконажиматель",
        < 500 => "📧 Писем рассыльщик",
        < 550 => "☕ Кофезависимый",
        < 600 => "🤦‍♂️ Виновник багов",
        < 650 => "🔄 Бесполезный оптимизатор",
        < 700 => "📝 Творческий копипастер",
        < 750 => "🤡 Офисный клоун",
        < 800 => "🖨️ Бумагомученик",
        < 850 => "📅 Календарный путаник",
        < 900 => "💻 Ноутбуконоситель",
        < 950 => "📱 Игрок в телефоне",
        < 1000 => "🚬 Перекурщик года",
        < 1050 => "🍩 Пончик с кофе",
        < 1100 => "🤯 Создатель проблем",
        < 1150 => "🛠️ Криворукий ремонтник",
        < 1200 => "📈 Лжестатистик",
        < 1250 => "💬 Болтун-профессионал",
        < 1300 => "🪓 Убийца времени",
        < 1350 => "🧾 Мастер отписок",
        < 1400 => "🤖 Робот-халтурщик",
        < 1450 => "🕵️‍♂️ Искатель оправданий",
        < 1500 => "📉 Разрушитель KPI",
        < 1550 => "💾 Хранитель мусорных файлов",
        < 1600 => "🖱️ Кликатель мышки",
        < 1650 => "⌨️ Слепой печатальщик",
        < 1700 => "📂 Папкоорганизатор",
        < 1750 => "🤹‍♂️ Жонглер задачами",
        < 1800 => "🧻 Офисный расходник",
        < 1850 => "🪑 Стулонаполнитель",
        < 1900 => "💡 Генератор бредовых идей",
        < 1950 => "📌 Кнопкодав",
        < 2000 => "🖍️ Рисователь диаграмм",
        < 2050 => "🧮 Калькуляторщик",
        < 2100 => "📠 Факс-реликтовщик",
        < 2150 => "📞 Телефонный игноратор",
        < 2200 => "🧯 Тушитель инициатив",
        < 2250 => "🪤 Ловец свободных минут",
        < 2300 => "🧹 Уборщик задач",
        < 2350 => "🛢️ Мазутчик офиса",
        < 2400 => "🪑 Табуреткотестировщик",
        < 2450 => "📉 Гуру спада продуктивности",
        < 2500 => "🪫 Разряженная батарейка",
        < 2550 => "🦥 Главный по зеванию",
        < 2600 => "🍜 Доедатель чужого ланча",
        < 2650 => "📵 Мастер 'я на связи'",
        < 2700 => "🤸‍♂️ Акробат на совещаниях",
        < 2750 => "🪂 Парашютист дедлайнов",
        < 2800 => "🧘‍♂️ Медитирующий на работе",
        < 2850 => "🎮 Консольный партизан",
        < 2900 => "📺 Сериальная жертва",
        < 2950 => "🛒 Магазинный диверсант",
        < 3000 => "🧻 Бумажный фантом",
        < 3050 => "🖌️ Художник по Excel",
        < 3100 => "🎣 Ловец свободных кресел",
        < 3150 => "🍪 Поглотитель печенек",
        < 3200 => "🧃 Соковый экстремист",
        < 3250 => "🛌 Лежачий спецназовец",
        < 3300 => "🧸 Офисный мишкозавр",
        < 3350 => "🪀 Йо-йо-менеджер",
        < 3400 => "🎲 Игрок в бизнес",
        < 3450 => "🧩 Собиратель пазлов задач",
        < 3500 => "🛹 Скользящий по KPI",
        < 3550 => "🎯 Стрелок мимо целей",
        < 3600 => "🤹 Жонглер отчетами",
        < 3650 => "🪁 Запускатель идей",
        < 3700 => "🎪 Офисный циркач",
        < 3750 => "🛌 Лежачий чемпион",
        < 3800 => "🍱 Бенто-боксёр",
        < 3850 => "🥊 Боец с принтером",
        < 3900 => "🛌 Сонный стратег",
        < 3950 => "🍕 Калорийный лидер",
        < 4000 => "🥱 Зевающий генерал",
        _ => "💀 Окончательно выгоревший"
    };
}